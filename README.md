# "Disease-economy trade-offs under alternative pandemic control strategies" replication package

This repository contains data, code, and images for the paper "Disease-economy trade-offs under alternative pandemic control strategies". The model output was generated in R 3.6.0, 3.6.3, and 4.0.1. Please contact Ana Bento (abento@iu.edu) or Akhil Rao (akhilr@middlebury.edu) if you have questions regarding the data or code used. 

### How is this repository organized?

	* /Code contains all of the R code used to generate model results.

	* /Data contains the contact matrices.

	* /Figures contains all of the figures used in the paper and code used to generate figures.

	* /Manuscript contains unformatted copies of the main text and SI for the paper.

### What does the code in /bin do?

Broadly, there are three types of code files: R files which describe functions and algorithms (e.g., "functions.R"), R scripts which implement various algorithms and calculations (e.g., "epicon_script.R"), and shell scripts which call the R scripts (e.g., "generate_figure_2_data.sh").

#### R codes

	* "epicon_script.R" is the main code which generates model output. Most other scripts either use this or its output. The default parameters are intended to be suitable for testing small-scale parameter variations. The model outputs used for figures were generated by passing script arguments through shell scripts. These shell scripts are described below.
		- "functions.R" contains functions used throughout the code. "dp_solver()" is the code for the main dynamic programming algorithm.

	* "calibrate_utility_parameters.R" is called by "epicon_script.R". It calibrates the utility function as described in Methods and SI. The default is to use analytical formulas for the static consumption-labor choices; an option for grid search is also available by setting the "numerical_calibration" flag on line 190 of epicon_script.R to 1.
		- This script outputs a set of csv files containing calibrated parameter values and measures of calibration accuracy.
		- "epicon_calibration_functions.R" and "functions.R" contain some functions and algorithms used here.

	* "contact_data_conversion.R" takes contact matrix data in /Data and calculates the appropriate mixing-adjusted average number of contacts for use as $\rho_c, \rho_l, \rho_o$ parameter values. These values are already coded in epicon_script.R; this script is included for reproducibility, but does not need to be re-run.

#### Data inputs

All data inputs necessary are coded in epicon_script.R. Sources for values and details for calculations are available in SI.

#### Model outputs

The main model output from epicon_script.R is a set of value and policy functions for the type of management strategy chosen. There are two valid types: "plan" for the social planner's outcome, and "eqm" for the decentralized outcome. Lockdown scenarios are generated from the decentralized value and policy functions. The script also produces a set of diagnostic plots over time and states to assess model behavior.

### How do I recreate the figures and data files?

The first step is to make sure R and the necessary R packages are installed. You can find a list of necessary packages in the header of /Code/epicon_script.R. Installing R should take 5-10 minutes; you can install R from [CRAN](https://cran.r-project.org/).

All code to generate final figures from summarized model output is in Figures/CODE-EPIECON_MS_Figs.R.

#### Generating the model output used in figures 2 and 3:

	* Run "generate_figure_2_data.sh".

	* Note that the number of cores is set to 80 by default; you will likely want to adjust this to match your computing equipment and time requirements. This code was run on a desktop computer running Ubuntu 20.04 with dual Intel Xeon Gold 6230 20C CPUs and 256 GB RAM, where it took roughly 5 hours. 
		- The memory requirement is relatively low, but the more cores the better. Each core used requires an additional copy of the data so will induce higher RAM use.

	* The header of the shell script describes the arguments to epicon_script.R.

	* Data summaries used in figures 2 and 3 are in the csv files in the Figures/Fig2/ folder. They are generated by running figure2_lines_sketch.R, which is in the same folder, on the value and policy functions produced from the shell script. The code also generates diagnostic plots to assess model output.

#### Generating the model output used in figures 4 and 5:

	* The value and policy functions used are outputs from "generate_figure_2_data.sh".

	* Data summaries are in the csv files in the Figures/Fig4/linear_behavior and Figures/Fig5/linear_behavior folders. They were generated by running the R scripts with the suffix "_main.R" in the same folders.
		- The csv files in Figures/Fig4/qre_behavior contain data summaries used in SI Figure S4. These can be generated by setting the "parms$eqm_concept" switch on line 54 of "info_lag_main.R" to "qre" instead of "linear".

#### Generating the model output used in figure 6 sensitivity analysis:

	* The model outputs were generated by running the shell scripts in the Figures/Fig6/hpc_scripts folder. The code for panels b-e was run on the BigRed3 system of the IU HPC cluster; detailed specifications can be found [here](https://kb.iu.edu/d/aoku). The code for panels f-g was run run on the Karst system of the IU HPC cluster; detailed specifications can be found [here](https://kb.iu.edu/d/bezu).
		- The scripts "run_fig6_rhoc_all.sh" and "run_fig6_rhoo_all.sh" in the folders panels_b_c/ and panels_d_e/ will spawn jobs for each point in the relevant panels.
		- Headers in the shell scripts describe the compute time and CPU/memory requirements for generating these outputs.

	* Data summaries used in figure 6 are in the csv files in the Figure_6/ folder. They are generated by running figure6_lines_sketch.R, which is in the same folder, on the value and policy functions produced from the shell scripts. The code also generates diagnostic plots to assess model output.

	for file in *.script; do mv "$file" "${file/fig4_/fig6_}"; done

#### Generating the model output used in figures S5 and S6:

	* These are generated by running "ensemble_valet.R". This script calls "generate_blanket_policy_ensemble.R" to generate the ensemble of lockdowns, then "ensemble_lines_sketch.R" and "generate_blanket_policy_series.R" to generate blanket lockdown outcome summaries and figures. "generate_blanket_policy_ensemble.R" was run on the Intel desktop described above using 16 cores.


